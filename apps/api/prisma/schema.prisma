generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum Campus {
  pilani
  goa
  hyderabad
  dubai
}

enum ConnectionStatus {
  pending
  accepted
  rejected
}

enum ConversationType {
  direct
  group
}

enum ConversationRole {
  member
  admin
}

enum MessageType {
  text
  image
  system
}

enum ContentType {
  image
  text
}

enum CommunityRole {
  member
  moderator
  admin
}

enum CommunityPostType {
  text
  image
  link
}

enum VoteType {
  up
  down
}

enum FeedPostType {
  text
  image
  achievement
}

enum MediaType {
  image
}

enum ReportType {
  user
  post
  comment
  message
  community
}

enum ReportStatus {
  pending
  reviewed
  resolved
}

// ─── Models ──────────────────────────────────────────────────────────────────

model User {
  id              String   @id @default(uuid())
  email           String   @unique
  username        String   @unique @db.VarChar(20)
  passwordHash    String   @map("password_hash")
  name            String   @db.VarChar(100)
  bio             String?  @db.Text
  profilePhotoUrl String?  @map("profile_photo_url") @db.VarChar(500)
  coverPhotoUrl   String?  @map("cover_photo_url") @db.VarChar(500)
  campus          Campus
  batchYear       Int      @map("batch_year")
  currentFocus    String?  @map("current_focus") @db.VarChar(200)
  isVerified      Boolean  @default(false) @map("is_verified")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  interests                UserInterest[]
  sentConnections          Connection[]              @relation("ConnectionRequester")
  receivedConnections      Connection[]              @relation("ConnectionAddressee")
  conversationParticipants ConversationParticipant[]
  messages                 Message[]
  stories                  Story[]
  storyViews               StoryView[]
  createdCommunities       Community[]
  communityMemberships     CommunityMember[]
  communityPosts           CommunityPost[]
  postVotes                PostVote[]
  comments                 Comment[]
  feedPosts                FeedPost[]
  feedPostLikes            FeedPostLike[]
  feedPostComments         FeedPostComment[]
  notifications            Notification[]
  blocksGiven              Block[]                   @relation("Blocker")
  blocksReceived           Block[]                   @relation("Blocked")
  reportsFiled             Report[]

  @@index([email])
  @@index([username])
  @@index([campus])
  @@index([createdAt])
  @@map("users")
}

model Interest {
  id       String @id @default(uuid())
  name     String @unique @db.VarChar(50)
  category String @db.VarChar(50)
  icon     String @db.VarChar(50)

  users UserInterest[]

  @@index([category])
  @@map("interests")
}

model UserInterest {
  userId     String   @map("user_id")
  interestId String   @map("interest_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest   Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@id([userId, interestId])
  @@map("user_interests")
}

model Connection {
  id          String           @id @default(uuid())
  requesterId String           @map("requester_id")
  addresseeId String           @map("addressee_id")
  status      ConnectionStatus @default(pending)
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  requester User @relation("ConnectionRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee User @relation("ConnectionAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([addresseeId])
  @@index([status])
  @@map("connections")
}

model Conversation {
  id        String           @id @default(uuid())
  type      ConversationType
  name      String?          @db.VarChar(50)
  photoUrl  String?          @map("photo_url") @db.VarChar(500)
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  participants ConversationParticipant[]
  messages     Message[]

  @@index([updatedAt])
  @@map("conversations")
}

model ConversationParticipant {
  conversationId String           @map("conversation_id")
  userId         String           @map("user_id")
  role           ConversationRole @default(member)
  joinedAt       DateTime         @default(now()) @map("joined_at")
  lastReadAt     DateTime?        @map("last_read_at")
  isMuted        Boolean          @default(false) @map("is_muted")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String      @id @default(uuid())
  conversationId String      @map("conversation_id")
  senderId       String      @map("sender_id")
  content        String      @db.VarChar(2000)
  messageType    MessageType @default(text) @map("message_type")
  mediaUrl       String?     @map("media_url") @db.VarChar(500)
  isDeleted      Boolean     @default(false) @map("is_deleted")
  createdAt      DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model Story {
  id              String      @id @default(uuid())
  userId          String      @map("user_id")
  contentType     ContentType @map("content_type")
  mediaUrl        String?     @map("media_url") @db.VarChar(500)
  textContent     String?     @map("text_content") @db.VarChar(500)
  backgroundColor String?     @map("background_color") @db.VarChar(7)
  expiresAt       DateTime    @map("expires_at")
  createdAt       DateTime    @default(now()) @map("created_at")

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  views StoryView[]

  @@index([userId])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("stories")
}

model StoryView {
  storyId  String   @map("story_id")
  viewerId String   @map("viewer_id")
  viewedAt DateTime @default(now()) @map("viewed_at")

  story  Story @relation(fields: [storyId], references: [id], onDelete: Cascade)
  viewer User  @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  @@id([storyId, viewerId])
  @@map("story_views")
}

model Community {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(50)
  description String?  @db.Text
  rules       String?  @db.Text
  iconUrl     String?  @map("icon_url") @db.VarChar(500)
  bannerUrl   String?  @map("banner_url") @db.VarChar(500)
  memberCount Int      @default(0) @map("member_count")
  isPrivate   Boolean  @default(false) @map("is_private")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  creator User              @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  members CommunityMember[]
  posts   CommunityPost[]

  @@index([name])
  @@index([createdAt])
  @@map("communities")
}

model CommunityMember {
  communityId String        @map("community_id")
  userId      String        @map("user_id")
  role        CommunityRole @default(member)
  joinedAt    DateTime      @default(now()) @map("joined_at")

  community Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([communityId, userId])
  @@map("community_members")
}

model CommunityPost {
  id           String            @id @default(uuid())
  communityId  String            @map("community_id")
  authorId     String            @map("author_id")
  title        String            @db.VarChar(300)
  content      String            @db.Text
  postType     CommunityPostType @default(text) @map("post_type")
  upvotes      Int               @default(0)
  downvotes    Int               @default(0)
  commentCount Int               @default(0) @map("comment_count")
  isPinned     Boolean           @default(false) @map("is_pinned")
  isDeleted    Boolean           @default(false) @map("is_deleted")
  createdAt    DateTime          @default(now()) @map("created_at")

  community Community  @relation(fields: [communityId], references: [id], onDelete: Cascade)
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  votes     PostVote[]
  comments  Comment[]

  @@index([communityId, createdAt])
  @@index([communityId, upvotes])
  @@index([authorId])
  @@map("community_posts")
}

model PostVote {
  postId   String   @map("post_id")
  userId   String   @map("user_id")
  voteType VoteType @map("vote_type")

  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([postId, userId])
  @@map("post_votes")
}

model Comment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  parentId  String?  @map("parent_id")
  authorId  String   @map("author_id")
  content   String   @db.Text
  upvotes   Int      @default(0)
  downvotes Int      @default(0)
  isDeleted Boolean  @default(false) @map("is_deleted")
  createdAt DateTime @default(now()) @map("created_at")

  post     CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent   Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[]     @relation("CommentReplies")
  author   User          @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@index([parentId])
  @@map("comments")
}

model FeedPost {
  id           String       @id @default(uuid())
  authorId     String       @map("author_id")
  content      String       @db.Text
  postType     FeedPostType @default(text) @map("post_type")
  likeCount    Int          @default(0) @map("like_count")
  commentCount Int          @default(0) @map("comment_count")
  isDeleted    Boolean      @default(false) @map("is_deleted")
  createdAt    DateTime     @default(now()) @map("created_at")

  author   User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  media    FeedPostMedia[]
  likes    FeedPostLike[]
  comments FeedPostComment[]

  @@index([authorId])
  @@index([createdAt])
  @@map("feed_posts")
}

model FeedPostMedia {
  id         String    @id @default(uuid())
  postId     String    @map("post_id")
  mediaUrl   String    @map("media_url") @db.VarChar(500)
  mediaType  MediaType @default(image) @map("media_type")
  orderIndex Int       @map("order_index")

  post FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("feed_post_media")
}

model FeedPostLike {
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  post FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([postId, userId])
  @@map("feed_post_likes")
}

model FeedPostComment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  authorId  String   @map("author_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  post   FeedPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt])
  @@map("feed_post_comments")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   @db.VarChar(50)
  title     String   @db.VarChar(200)
  body      String   @db.Text
  data      Json?    @db.JsonB
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model Block {
  blockerId String   @map("blocker_id")
  blockedId String   @map("blocked_id")
  createdAt DateTime @default(now()) @map("created_at")

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@id([blockerId, blockedId])
  @@map("blocks")
}

model Report {
  id           String       @id @default(uuid())
  reporterId   String       @map("reporter_id")
  reportedType ReportType   @map("reported_type")
  reportedId   String       @map("reported_id")
  reason       String       @db.VarChar(50)
  description  String?      @db.Text
  status       ReportStatus @default(pending)
  createdAt    DateTime     @default(now()) @map("created_at")

  reporter User @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([status])
  @@map("reports")
}
